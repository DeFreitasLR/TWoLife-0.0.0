---
title: "Part 1: Exploring Landscape Configurations with TWoLife: A SLOSS Analysis"
author: "Lucas Freitas"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Exploring Landscape Configurations with TWoLife: A SLOSS Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  fig.align = "center"
)
```

# Introduction

This vignette demonstrates the capabilities of the **TWoLife** package through a classic conservation ecology question: the SLOSS debate. SLOSS asks whether **S**ingle **L**arge **o**r **S**everal **S**mall habitat reserves better support viable populations.

We explore this question using individual-based simulations across three landscape configurations:


1. **Pristine baseline** — 100% habitat coverage (control)
2. **Single Large patch** — 20% Coverage - one contiguous reserve 
3. **Several Small patches** — 20% Coverage - multiple small reserves with equivalent total area

# Setup and Initialization

We begin by loading the package and setting a master seed for full reproducibility:

```{r load-package}
library(TWoLife)

# Single master seed for full reproducibility
MASTER_SEED <- 42

# Clear any existing random state
if (exists(".Random.seed", envir = .GlobalEnv)) {
  rm(.Random.seed, envir = .GlobalEnv)
}
set.seed(MASTER_SEED)
```

# Landscape Configurations

## Creating the Landscapes

TWoLife provides a suite of landscape creation functions. For our pristine baseline, we create a fractal landscape with 100% habitat coverage:

```{r pristine-landscape}
pristine_landscape <- create_fractal_landscape(
  cells_per_row = 15,
  fractality = 0.5,
  habitat_proportion = 1.0
)
```

For the SLOSS comparison, we use pre-configured landscapes from the package:

```{r sloss-landscapes}
single_large_patch <- single_large
several_small_patches <- several_small
```

## Visualizing the Landscapes

```{r visualize-landscapes, fig.width=9, fig.height=3}
par(mfrow = c(1, 3), mar = c(4, 4, 3, 2))

plot_landscape_world_coords(pristine_landscape, 
                            main = "Pristine Landscape\n(Baseline Control)", 
                            colors = "habitat")
plot_landscape_world_coords(single_large_patch, 
                            main = "Single Large Patch\n(SLOSS: SL Strategy)", 
                            colors = "habitat")
plot_landscape_world_coords(several_small_patches, 
                            main = "Several Small Patches\n(SLOSS: SS Strategy)", 
                            colors = "habitat")
```

Each landscape consists of `r nrow(pristine_landscape)` × `r ncol(pristine_landscape)` cells, with habitat cells (green) available for colonization and matrix cells (white) acting as barriers.

# Running the Simulations

We simulate population dynamics on each landscape configuration, starting with 100 individuals and running for 300 time units. All simulations use the same master seed to ensure comparability—only the landscape differs between treatments.

```{r run-simulations}
sim_pristine <- twolife_simulation(
  landscape_params = list(habitat = pristine_landscape),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)

sim_single_large <- twolife_simulation(
  landscape_params = list(habitat = single_large_patch),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)

sim_several_small <- twolife_simulation(
  landscape_params = list(habitat = several_small_patches),
  individual_params = list(initial_population_size = 100),
  simulation_params = list(max_events = 300),
  master_seed = MASTER_SEED
)
```

# Results

## Final Population Sizes

We compare final population sizes across landscape configurations:

```{r final-populations}
final_populations <- c(
  Pristine = sim_pristine$summary$final_population_size,
  Single_Large = sim_single_large$summary$final_population_size,
  Several_Small = sim_several_small$summary$final_population_size
)

final_populations
```

### Outcome: Extinction in Fragmented Landscape

The results reveal a **critical threshold effect**: while the Single Large patch sustained a viable population of **`r final_populations["Single_Large"]` individuals**, the Several Small configuration experienced **complete population collapse** (N = 0).

This extinction event demonstrates that landscape configuration can determine not just population size, but population persistence itself. Despite having identical total habitat area (20% coverage), fragmentation into multiple small patches created conditions incompatible with long-term survival.

### Relative Performance

```{r relative-performance}
# Calculate percentages relative to pristine baseline
pct_single_large <- (final_populations["Single_Large"] / final_populations["Pristine"]) * 100
pct_several_small <- (final_populations["Several_Small"] / final_populations["Pristine"]) * 100
loss_from_fragmentation <- pct_single_large - pct_several_small

# Display as table
relative_to_pristine <- c(
  "Pristine (%)" = 100.0,
  "Single Large (%)" = round(pct_single_large, 1),
  "Several Small (%)" = round(pct_several_small, 1)
)
relative_to_pristine
```

The Single Large patch retained **`r round(pct_single_large, 1)`%** of the pristine landscape's carrying capacity—a substantial reduction, but still viable. In contrast, the Several Small patches could not support any individuals, representing a **`r round(loss_from_fragmentation, 1)`% loss** in conservation value compared to the contiguous reserve.


## Spatial Distribution of Survivors

```{r survivor-distribution, fig.width=9, fig.height=3}
par(mfrow = c(1, 3), mar = c(4, 4, 3, 2))

plot_simulation_on_landscape(sim_pristine, 
                             main = sprintf("Survivors: Pristine\n(N = %d)", 
                                            final_populations["Pristine"]),
                             point_color = "darkgreen", point_size = 1.5)

plot_simulation_on_landscape(sim_single_large, 
                             main = sprintf("Survivors: Single Large\n(N = %d)", 
                                            final_populations["Single_Large"]),
                             point_color = "blue", point_size = 1.5)

plot_simulation_on_landscape(sim_several_small, 
                             main = sprintf("Survivors: Several Small\n(N = %d)", 
                                            final_populations["Several_Small"]),
                             point_color = "red", point_size = 1.5)
```

## Population Trajectories

To understand population dynamics over time, we extract and visualize the population trajectories:

```{r population-trajectories}
trajectory_pristine <- compute_population_size(sim_pristine)
trajectory_single_large <- compute_population_size(sim_single_large)
trajectory_several_small <- compute_population_size(sim_several_small)
```

```{r plot-trajectories, fig.width=7, fig.height=5}
par(mfrow = c(1, 1), mar = c(5, 4, 4, 2))

max_pop <- max(c(trajectory_pristine$population_size, 
                 trajectory_single_large$population_size, 
                 trajectory_several_small$population_size))

plot(trajectory_pristine$time, trajectory_pristine$population_size, 
     type = "l", col = "darkgreen", lwd = 2,
     main = "Population Trajectories: SLOSS Comparison", 
     xlab = "Time (arbitrary units)", 
     ylab = "Population Size (N)",
     ylim = c(0, max_pop * 1.05))

lines(trajectory_single_large$time, trajectory_single_large$population_size, 
      col = "blue", lwd = 2)
lines(trajectory_several_small$time, trajectory_several_small$population_size, 
      col = "red", lwd = 2)

abline(h = 100, lty = 2, col = "gray50")
```

## Summary Comparison

```{r final-comparison, fig.width=6, fig.height=5}
barplot(final_populations, 
        main = "Final Population Sizes: SLOSS Comparison",
        ylab = "Final Population Size (N)",
        col = c("darkgreen", "blue", "red"),
        las = 1,
        ylim = c(0, max(final_populations) * 1.15))

text(x = seq(0.7, by = 1.2, length.out = 3), 
     y = final_populations + max(final_populations) * 0.05,
     labels = final_populations,
     cex = 1.2, font = 2)
```

# Ecological Interpretation

## Habitat Loss and Carrying Capacity

Comparing the pristine baseline to the single large patch reveals the fundamental cost of habitat loss. Even when habitat remains contiguous, the pristine landscape supports **`r final_populations["Pristine"] - final_populations["Single_Large"]` more individuals** than the single large configuration—a **`r round((1 - final_populations["Single_Large"] / final_populations["Pristine"]) * 100, 1)`% reduction** in carrying capacity. This reduction reflects both the loss of foraging area and the increased proportion of edge habitat, where individuals may experience reduced resource availability and increased exposure to matrix conditions.

## The SLOSS Question: Configuration Effects

Beyond total habitat area, configuration also matters. In this simulation, the `r if(final_populations["Single_Large"] > final_populations["Several_Small"]) "**Single Large**" else if(final_populations["Several_Small"] > final_populations["Single_Large"]) "**Several Small**" else "**neither**"` strategy supports a larger population, with a difference of **`r abs(final_populations["Single_Large"] - final_populations["Several_Small"])` individuals**. `r if(final_populations["Single_Large"] > final_populations["Several_Small"]) "This outcome supports the 'Single Large' hypothesis and suggests that core habitat area outweighs potential benefits of spatial spreading. The contiguous patch likely provides more continuous resource availability and reduces mortality risks associated with inter-patch movement through the hostile matrix." else if(final_populations["Several_Small"] > final_populations["Several_Small"]) "This outcome supports the 'Several Small' hypothesis and suggests that spatial heterogeneity in resource distribution may favor multiple patches. The fragmented configuration could provide bet-hedging benefits through demographic asynchrony or facilitate colonization of underutilized habitat." else "The equivalent performance of both strategies suggests that, under these parameter settings, edge effects and core habitat area balance against potential benefits of spatial spreading."`

## Population Dynamics and Equilibrium

The population trajectories reveal how each landscape's carrying capacity emerges from the founding population of 100 individuals. Depending on the relationship between initial density and resource availability, populations may initially grow, decline, or fluctuate before stabilizing. As populations approach their respective equilibria, density-dependent processes—competition for space and resources, local depletion, and crowding effects—increasingly regulate population size. The differences in equilibrium population sizes reflect the interplay between total habitat availability, edge-to-core ratios, and the spatial configuration of usable resources.

These patterns underscore a key insight for conservation planning: **reserve design involves trade-offs between total area, spatial configuration, and connectivity**. The optimal strategy depends on species-specific traits (dispersal ability, edge sensitivity, resource requirements) and landscape context (matrix permeability, disturbance regimes, resource heterogeneity).

# Conclusion

This vignette demonstrates how TWoLife can be used to explore classic questions in conservation ecology through individual-based simulations. The SLOSS analysis reveals how landscape configuration affects population viability, providing quantitative insights into reserve design strategies.

The framework shown here can be extended to investigate:

- Heterogeneous landscapes with variable resource quality
- Individual variation in resource use and movement behavior  
- Different fragmentation patterns and connectivity scenarios
- Temporal dynamics under environmental change

For more advanced applications, see the additional vignettes in the TWoLife package documentation.