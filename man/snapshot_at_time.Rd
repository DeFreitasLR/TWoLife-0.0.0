% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/functions.R
\name{snapshot_at_time}
\alias{snapshot_at_time}
\title{Reconstruct Population State at Specific Time}
\usage{
snapshot_at_time(
  simulation_result,
  target_time,
  color_by = "genotype",
  show_plot = TRUE,
  point_size = 2
)
}
\arguments{
\item{simulation_result}{A 'twolife_result' object from \code{\link{twolife_simulation}}.
Must have been created with \code{history_detail = "standard"} or \code{"full"}.
The "minimal" history level lacks spatial coordinates and cannot be used.}

\item{target_time}{Numeric. Time point to reconstruct population state (in simulation time units).
Must be \eqn{\geq 0} and \eqn{\leq} maximum simulation time. If larger than max time,
automatically uses final time with a warning.}

\item{color_by}{Character. Trait used to color points in visualization:
\itemize{
  \item "genotype" - Color by genetic environmental optimum (\eqn{\mu_g})
  \item "phenotype" - Color by expressed phenotype (\eqn{\mu_p = \mu_g + \epsilon}). 
    Requires history_detail = "full"
  \item "none" - Single color (red) for all individuals
}}

\item{show_plot}{Logical. If TRUE, displays spatial visualization of reconstructed population
with landscape background.}

\item{point_size}{Numeric. Size of points representing individuals in the plot.}
}
\value{
Invisibly returns a list with components:
  \describe{
    \item{time}{Numeric. The actual time used (may differ from input if capped at max time)}
    \item{n_alive}{Integer. Number of living individuals at target_time}
    \item{population}{Data frame with columns:
      \itemize{
        \item id: Integer individual ID
        \item x, y: Numeric world coordinates
        \item genotype: Numeric genetic optimum value
        \item phenotype: Numeric phenotype (NA if history_detail != "full")
        \item width: Numeric niche width (\eqn{\sigma_g}, NA if history_detail != "full")
        \item patch_id: Integer landscape cell ID
      }}
    \item{events_processed}{Integer. Number of events processed up to target_time}
    \item{history_level}{Character. The history_detail level: "standard" or "full"}
  }
}
\description{
Replays the event log from a simulation to reconstruct the exact spatial distribution,
genotypes, and phenotypes of all living individuals at a specified time point. 
Essential for temporal analysis, creating animations, studying critical demographic 
transitions, and visualizing spatial-genetic patterns through time.
}
\details{
## Reconstruction Algorithm

The function reconstructs population state using:

\deqn{P(t) = \{i : t_{\text{birth},i} \leq t < t_{\text{death},i}\}}

Where:
\itemize{
  \item \eqn{P(t)} = set of individuals alive at time \eqn{t}
  \item \eqn{t_{\text{birth},i}} = birth time of individual \eqn{i}
  \item \eqn{t_{\text{death},i}} = death/emigration time of individual \eqn{i} 
    (or \eqn{+\infty} if still alive)
}

Pseudocode:
```
1. Initialize empty population tracker
2. Filter events: keep only events with time <= target_time
3. For each event in chronological order:
   - If birth (type = 1) or initial (type = -1): Add individual to alive set
   - If death (type = 0) or emigration (type = 3): Remove from alive set
   - If movement (type = 2): Update position of individual
4. For each alive individual, retrieve most recent state (position, genotype, phenotype)
5. Return reconstructed population
```

## Temporal Resolution

Reconstruction accuracy depends on event density:
\itemize{
  \item **High temporal resolution**: Many events per time unit → precise state reconstruction
  \item **Low temporal resolution**: Few events per time unit → states may span long intervals
  \item Between events, individual states remain constant (positions frozen until next movement)
}

This reflects the event-based nature of individual-based models: changes only occur 
at discrete event times.

## History Detail Requirements

\tabular{lll}{
  \strong{history_detail} \tab \strong{Available Data} \tab \strong{color_by Options} \cr
  "minimal" \tab Event times, types only \tab Cannot reconstruct \cr
  "standard" \tab + positions, genotypes \tab "genotype", "none" \cr
  "full" \tab + phenotypes, niche widths \tab All options \cr
}

## Visualization Components

When show_plot = TRUE:
\itemize{
  \item **Background**: Habitat values from landscape matrix
  \item **Points**: Individual positions colored by selected trait
  \item **Title**: Shows target_time and number of individuals alive
  \item **Legend**: Maps colors to trait values (if color_by != "none")
}

## Animation Workflow

To create animations:
1. Get time points: \code{times <- seq(0, max_time, length.out = 50)}
2. For each time: \code{snapshot_at_time(result, t)}
3. Save plots or compile frames into video

See Examples for complete animation code.
}
\examples{
\donttest{
set.seed(50)
continuous_landscape <- create_fractal_landscape(
  cells_per_row = 5,
  fractality    = 0.5,
  min_value     = 0.0,
  max_value     = 100.0
)
initial_pop_size  <- 1000
initial_genotypes <- seq(0, 100, length.out = initial_pop_size)
result_genetic <- twolife_simulation(
  landscape_params = list(
    habitat                     = continuous_landscape,
    cell_size                   = 1.0,
    boundary_condition          = 1,
    density_type                = 1,
    matrix_mortality_multiplier = 2.0,
    matrix_dispersal_multiplier = 0.5
  ),
  individual_params = list(
    initial_population_size = initial_pop_size,
    neighbor_radius         = 2.0,
    vision_angle            = pi,
    step_length             = 5.0,
    base_dispersal_rate     = 0.4,
    base_birth_rate         = 0.6,
    base_mortality_rate     = 0.2,
    birth_density_slope     = 0.02,
    mortality_density_slope = 0.02
  ),
  genetic_params = list(
    genotype_means                 = initial_genotypes,
    genotype_sds                   = rep(0.4,   initial_pop_size),
    mutation_rates                 = rep(0.001, initial_pop_size),
    plasticities                   = rep(0.001, initial_pop_size),
    sampling_points                = rep(10,    initial_pop_size),
    habitat_selection_temperatures = rep(0.1,   initial_pop_size)
  ),
  simulation_params = list(max_events = 100),
  master_seed = 49
)

# Get snapshot at middle of simulation
mid_time     <- result_genetic$summary$duration / 2
snapshot_mid <- snapshot_at_time(result_genetic, target_time = mid_time)

# Get final snapshot
snapshot_final <- snapshot_at_time(result_genetic, target_time = Inf)
}
}
\seealso{
\code{\link{population_size}} for population trajectories,
  \code{\link{twolife_simulation}} for running simulations with appropriate history_detail,
  \code{\link{check_habitat_match}} for analyzing trait-habitat matching
}
